<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel Pre-Assessment (Sets A → C) + Radar + Google Sheet Submit</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e9eefc;
      --muted:#b8c3e6;
      --accent:#7aa2ff;
      --line:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(61,220,151,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    header{max-width:1040px; margin:24px auto 0; padding:0 16px;}
    h1{margin:0 0 6px; font-size:22px; font-weight:750; letter-spacing:.2px;}
    .sub{margin:0; color:var(--muted); font-size:13px;}
    .wrap{
      max-width:1040px; margin:14px auto 40px; padding:0 16px;
      display:grid; grid-template-columns:1.25fr .75fr; gap:14px;
    }
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
    }
    .panelTitle{
      font-weight:750; margin:0 0 10px; font-size:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background: rgba(0,0,0,.18);
      color:var(--muted); font-size:12px; white-space:nowrap;
    }
    .progressBar{height:8px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid var(--line);}
    .progressBar > div{height:100%; width:0%; background: linear-gradient(90deg, var(--accent), rgba(61,220,151,.95)); transition:width .35s ease;}
    .qblock{padding:10px 0; border-top:1px solid var(--line);}
    .qblock:first-of-type{border-top:none; padding-top:0;}
    .qtitle{margin:0 0 8px; font-weight:700; font-size:13px;}
    .hint{color:var(--muted); font-size:12px; margin:0 0 10px;}
    label.opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px; border-radius:12px;
      border:1px solid transparent; background: rgba(0,0,0,.10);
      margin:8px 0; cursor:pointer;
      transition:border-color .2s ease, background .2s ease;
      user-select:none;
    }
    label.opt:hover{border-color: rgba(122,162,255,.35); background: rgba(122,162,255,.08);}
    input[type="radio"], input[type="checkbox"]{margin-top:2px; accent-color: var(--accent); transform: scale(1.05);}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1}
    .txt{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
    button{
      border:none; border-radius:12px;
      padding:10px 14px; font-weight:700; cursor:pointer;
      transition: transform .05s ease, opacity .2s ease;
    }
    button:active{transform: translateY(1px)}
    .primary{background: var(--accent); color:#071023}
    .ghost{background: rgba(255,255,255,.08); color: var(--text); border:1px solid var(--line);}
    .danger{background: rgba(255,92,122,.16); color: var(--text); border:1px solid rgba(255,92,122,.35);}
    .side p{margin:8px 0; color:var(--muted); font-size:12px;}
    .metric{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 10px; border-radius:12px; border:1px solid var(--line);
      background: rgba(0,0,0,.16); margin:8px 0; gap:10px;
    }
    .badge{
      padding:5px 9px; border-radius:999px; border:1px solid var(--line);
      font-size:12px; font-weight:800; white-space:nowrap;
      background: rgba(0,0,0,.16);
    }
    .bGood{background: rgba(61,220,151,.14); border-color: rgba(61,220,151,.35);}
    .bWarn{background: rgba(255,209,102,.14); border-color: rgba(255,209,102,.35);}
    .bBad{background: rgba(255,92,122,.14); border-color: rgba(255,92,122,.35);}
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .kpi .metric{margin:0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .hidden{display:none !important}
    .footerNote{margin-top:12px; color:var(--muted); font-size:11px; opacity:.95;}
    .hr{height:1px; background: var(--line); margin:12px 0;}
    .list{margin:8px 0 0 16px; color: var(--muted); font-size:12px;}
    .cta{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .toast{
      position:fixed; bottom:14px; left:50%; transform: translateX(-50%);
      background: rgba(0,0,0,.60); border:1px solid var(--line);
      color: var(--text); padding:10px 12px; border-radius:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      font-size:12px; opacity:0; pointer-events:none; transition: opacity .2s ease;
      max-width:92vw;
    }
    .toast.show{opacity:1}

    /* Radar layout */
    .radarGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start;}
    @media (max-width: 980px){ .radarGrid{grid-template-columns:1fr} }
    .radarWrap{border:1px solid var(--line); background: rgba(0,0,0,.14); border-radius:14px; padding:12px;}
    canvas{max-width:100%}
    .legend{border:1px solid var(--line); background: rgba(0,0,0,.14); border-radius:14px; padding:12px;}
    .mini{font-size:11px; color:var(--muted); margin-top:6px;}
  </style>
</head>

<body>
<header>
  <h1>Microsoft Excel Pre-Assessment (Sets A → C)</h1>
  <p class="sub">
    10-minute diagnostic. Auto-interprets candidate level and recommends training enrollment level.
  </p>
</header>

<div class="wrap">
  <main class="card">
    <div class="panelTitle">
      <span id="stepTitle">Start</span>
      <span class="pill">
        <span id="stepPill">0/0</span>
        <span class="mono" id="timerPill">10:00</span>
      </span>
    </div>

    <div class="progressBar"><div id="progressFill"></div></div>

    <div id="screenStart" class="qblock">
      <p class="hint">
        This assessment has three stages: <b>Set A</b> (experience), <b>Set B</b> (tool recognition), <b>Set C</b> (advanced thinking).
        It is diagnostic only.
      </p>

      <div class="row">
        <div>
          <p class="qtitle">Participant Name <span class="hint">(required)</span></p>
          <input class="txt" id="participantName" placeholder="e.g., Aina, Kumar, Kelvin" />
        </div>
        <div>
          <p class="qtitle">Department <span class="hint">(required)</span></p>
          <input class="txt" id="participantDept" placeholder="e.g., HR, Finance, Operations" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <p class="qtitle">Job Role / Title <span class="hint">(required)</span></p>
          <input class="txt" id="participantRole" placeholder="e.g., HR Executive, Accounts Assistant, Analyst" />
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnStart">Start Assessment</button>
        <button class="ghost" id="btnLoadSample">Load Demo Answers</button>
      </div>

      <div class="footerNote">
        Trainer tip: Tell participants “Answer based on what you actually do at work. This helps place you in the right class.”
      </div>
    </div>

    <div id="questionHost" class="hidden"></div>

    <div id="screenResult" class="hidden">
      <div class="qblock">
        <p class="qtitle">Result Summary</p>
        <p class="hint" id="resultSummaryText"></p>

        <div class="kpi">
          <div class="metric">
            <div><b>Overall Level</b><div class="hint" style="margin:4px 0 0">Recommended enrollment</div></div>
            <span class="badge" id="overallBadge">—</span>
          </div>
          <div class="metric">
            <div><b>Total Score</b><div class="hint" style="margin:4px 0 0">Across Sets A+B+C</div></div>
            <span class="badge" id="scoreBadge">—</span>
          </div>
          <div class="metric">
            <div><b>Set A</b><div class="hint" style="margin:4px 0 0">Experience ticks</div></div>
            <span class="badge" id="aBadge">—</span>
          </div>
          <div class="metric">
            <div><b>Set B</b><div class="hint" style="margin:4px 0 0">Micro scenarios</div></div>
            <span class="badge" id="bBadge">—</span>
          </div>
          <div class="metric">
            <div><b>Set C</b><div class="hint" style="margin:4px 0 0">Thinking maturity</div></div>
            <span class="badge" id="cBadge">—</span>
          </div>
          <div class="metric">
            <div><b>Confidence Signals</b><div class="hint" style="margin:4px 0 0">No scoring, trainer insight</div></div>
            <span class="badge" id="confBadge">—</span>
          </div>
        </div>

        <div class="hr"></div>

        <p class="qtitle">Strengths & Weaknesses Radar</p>
        <p class="hint">Scores are normalized (0–5). Use this to tailor pacing and emphasis in class.</p>

        <div class="radarGrid">
          <div class="radarWrap">
            <canvas id="radar" width="520" height="420"></canvas>
            <div class="mini mono">Scale: 0 to 5</div>
          </div>
          <div class="legend">
            <div class="panelTitle" style="margin-bottom:6px">
              <span>Top Focus Areas</span>
              <span class="pill mono" id="radarLevelPill">—</span>
            </div>
            <div id="radarFocusList"></div>
            <div class="footerNote">Rule of thumb: any axis ≤ 2 is a “needs support” zone.</div>
          </div>
        </div>

        <div class="hr"></div>

        <p class="qtitle">Recommendation</p>
        <p class="hint" id="recommendationText"></p>
        <ul class="list" id="interpretList"></ul>

        <div class="cta">
          <button class="primary" id="btnUpload" style="background:#4285F4; color:white">Submit</button>
          
          <button class="ghost" id="btnDownload">Download (JSON)</button>
          <button class="ghost" id="btnDownloadWord">Download (Word .doc)</button>
          <button class="danger" id="btnReset">Reset</button>
        </div>

        <div class="footerNote">
          Submitting sends your result to the central database. You can also download a copy for your records.
        </div>
      </div>
    </div>

    <div class="btnRow hidden" id="navButtons">
      <button class="ghost" id="btnBack">Back</button>
      <button class="primary" id="btnNext">Next</button>
    </div>
  </main>

  <aside class="card">
    <div class="panelTitle">
      <span>Trainer Dashboard</span>
      <span class="pill mono" id="stagePill">Stage: —</span>
    </div>

    <div class="metric">
      <div><b>Time Remaining</b><p class="sub" style="margin:4px 0 0">Default: 10 minutes</p></div>
      <span class="badge mono" id="timeBadge">10:00</span>
    </div>

    <div class="metric">
      <div><b>Completion</b><p class="sub" style="margin:4px 0 0">Answered questions</p></div>
      <span class="badge mono" id="completionBadge">0/0</span>
    </div>

    <div class="metric">
      <div><b>Auto-Scoring</b><p class="sub" style="margin:4px 0 0">Live estimate</p></div>
      <span class="badge mono" id="liveEstimate">—</span>
    </div>

    <p class="footerNote">
      Save as <span class="mono">excel-assessment.html</span> and open in any modern browser.
    </p>
  </aside>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   DATA MODEL
========================= */
const APP = {
  durationSeconds: 10 * 60,
  timer: null,
  remaining: 10 * 60,
  idx: 0,
  flatQuestions: [],
  answers: {},
  meta: { name: "", dept: "", role: "", startedAt: null, endedAt: null }
};

const QUESTION_SETS = [
  {
    id: "A",
    title: "Set A — Experience Check",
    intro: "Tick tasks you have personally done in Excel without step-by-step guidance.",
    questions: [
      {
        id: "A1",
        type: "checkbox",
        title: "Which of the following have you personally done in Excel?",
        hint: "Select all that apply.",
        options: [
          "Enter and format data neatly (alignment, borders, number formats)",
          "Use basic formulas (SUM, AVERAGE, COUNT)",
          "Use IF formulas",
          "Use VLOOKUP or XLOOKUP",
          "Sort and filter data",
          "Convert data into Excel Tables",
          "Create PivotTables",
          "Create charts from data",
          "Clean data (remove duplicates, split text, fix inconsistent formats)"
        ],
        score: (ans) => Array.isArray(ans) ? ans.length : 0,
        max: 9
      }
    ]
  },
  {
    id: "B",
    title: "Set B — Micro Scenarios",
    intro: "Choose the best answer. These are practical, real-work decisions (not an exam).",
    questions: [
      { id:"B1", type:"mcq", title:"You receive a list of 2,000 records. You want to quickly view only Sales above RM5,000 for April. What is the best approach?", options:["Manually delete other rows","Sort the Sales column","Use Filter with conditions","Copy data to another sheet"], correctIndex:2 },
      { id:"B2", type:"mcq", title:"You need to retrieve Department Name based on Employee ID from another table. Which feature is most appropriate?", options:["SUM","IF","VLOOKUP / XLOOKUP","PivotTable"], correctIndex:2 },
      { id:"B3", type:"mcq", title:"Your data range keeps growing every month. Which feature helps formulas and charts update automatically?", options:["Merged cells","Excel Table","Conditional Formatting","Freeze Panes"], correctIndex:1 },
      { id:"B4", type:"mcq", title:"Management asks for total sales by region and month, and they may change the view later. What should you use?", options:["Manual formulas only","Chart only","PivotTable","Sorting"], correctIndex:2 },
      { id:"B5", type:"mcq", title:"You see duplicated customer records in a list. What is the fastest way to clean this?", options:["Delete rows manually","Filter and delete","Remove Duplicates tool","Rewrite the data"], correctIndex:2 },
      { id:"B6", type:"mcq", title:"You want to visually compare monthly performance trends. Which chart is most suitable?", options:["Pie chart","Line chart","Scatter chart","Radar chart"], correctIndex:1 },
      { id:"B7", type:"mcq", title:"A column contains “John Tan – Sales – KL”. You want each part in a separate column. What should you use?", options:["Find & Replace","Text to Columns","PivotTable","Sort"], correctIndex:1 },
      {
        id: "B8",
        type: "likert",
        title: "Confidence snapshot (not scored): How confident are you doing the following without help or Google?",
        hint: "Used for trainer insight only.",
        scale: ["Never", "Tried once", "Sometimes", "Confident"],
        items: [
          "Creating a PivotTable from raw data",
          "Fixing messy data before analysis",
          "Choosing the right chart for management"
        ]
      }
    ]
  },
  {
    id: "C",
    title: "Set C — Advanced Thinking",
    intro: "This stage checks how you think and design Excel work so it is reusable, reliable, and fast.",
    questions: [
      { id:"C1", type:"mcq", title:"When you receive a new dataset, what do you normally do first?", options:["Start creating charts","Clean and understand the data structure","Write formulas immediately","Send it to someone else"], correctIndex:1 },
      { id:"C2", type:"mcq", title:"A report needs to be updated every month using similar data. What approach makes the most sense?", options:["Recreate the report each month","Copy and paste last month’s report","Build something reusable and structured","Export everything to PDF"], correctIndex:2 },
      { id:"C3", type:"mcq", title:"You notice a formula works, but no one else understands it. What is the best practice?", options:["Leave it as long as it works","Add comments or structure to make it clearer","Lock the worksheet","Convert it to values"], correctIndex:1 },
      { id:"C4", type:"mcq", title:"You want a report that allows management to change views, drill into details, and ask “what-if” questions. Which approach supports this best?", options:["Static charts","Fixed formulas","PivotTable-based report","Screenshots"], correctIndex:2 },
      { id:"C5", type:"mcq", title:"You have messy data from multiple sources. What is the correct sequence?", options:["Chart → Clean → Analyse","Analyse → Chart → Clean","Clean → Structure → Analyse","Analyse only"], correctIndex:2 },
      { id:"C6", type:"mcq", title:"You need to retrieve values from another table, but the column position may change. What is the safest approach?", options:["VLOOKUP with fixed column number","Hard-coded values","XLOOKUP or structured reference","Copy-paste"], correctIndex:2 },
      { id:"C7", type:"mcq", title:"A colleague asks you to “make Excel faster” for a report. What would you look at first?", options:["Computer hardware","Fonts and colours","Formula logic and data structure","Worksheet name"], correctIndex:2 },
      { id:"C8", type:"mcq", title:"You want to ensure others don’t accidentally break your report. What is the best design choice?", options:["Hide all sheets","Lock everything","Separate input, logic, and output areas","Convert everything to PDF"], correctIndex:2 },
      { id:"C9", type:"mcq", title:"Which statement best describes you?", options:["I follow step-by-step instructions exactly","I can adapt examples to my own work","I understand why Excel tools are used, not just how","I avoid complex Excel tasks"], correctIndex:2 },
      { id:"C10", type:"mcq", title:"When Excel gives an unexpected result, you usually:", options:["Re-enter the formula","Google immediately","Break the problem into smaller parts and test","Ask someone else"], correctIndex:2 }
    ]
  }
];

/* =========================
   HELPERS
========================= */
const el = (id) => document.getElementById(id);

function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2000);
}
function fmtTime(sec){
  const m = Math.floor(sec / 60), s = sec % 60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function setStage(stageText){ el("stagePill").textContent = "Stage: " + stageText; }
function showScreen(name){
  el("screenStart").classList.add("hidden");
  el("questionHost").classList.add("hidden");
  el("screenResult").classList.add("hidden");
  el("navButtons").classList.add("hidden");
  if (name === "start") el("screenStart").classList.remove("hidden");
  if (name === "q"){ el("questionHost").classList.remove("hidden"); el("navButtons").classList.remove("hidden"); }
  if (name === "result") el("screenResult").classList.remove("hidden");
}
function answeredCount(){
  let c=0;
  for (const q of APP.flatQuestions) if (APP.answers[q.id] !== undefined) c++;
  return c;
}
function updateProgress(){
  const total = APP.flatQuestions.length;
  const current = Math.min(APP.idx+1, total);
  el("stepPill").textContent = `${current}/${total}`;
  el("completionBadge").textContent = `${answeredCount()}/${total}`;
  const pct = total ? (APP.idx / total) * 100 : 0;
  el("progressFill").style.width = `${Math.max(0, Math.min(100, pct))}%`;
  el("timerPill").textContent = fmtTime(APP.remaining);
  el("timeBadge").textContent = fmtTime(APP.remaining);
  el("liveEstimate").textContent = liveEstimateLabel();
}
function liveEstimateLabel(){
  const scores = computeScores();
  if (!scores.started) return "—";
  return `${interpretLevel(scores).level} (est.)`;
}

/* =========================
   RENDER QUESTIONS
========================= */
function buildFlatQuestions(){
  const flat=[];
  for (const set of QUESTION_SETS){
    for (const q of set.questions){
      flat.push({ ...q, setId:set.id, setTitle:set.title, setIntro:set.intro });
    }
  }
  APP.flatQuestions = flat;
}

function renderCurrentQuestion(){
  const host = el("questionHost");
  host.innerHTML = "";
  const q = APP.flatQuestions[APP.idx];
  if (!q){ finishAssessment(); return; }

  el("stepTitle").textContent = q.setTitle;
  setStage(q.setTitle.split("—")[0].trim());
  updateProgress();

  const isFirstOfSet = APP.idx === 0 || APP.flatQuestions[APP.idx-1].setId !== q.setId;
  if (isFirstOfSet){
    const intro = document.createElement("div");
    intro.className = "qblock";
    intro.innerHTML = `<p class="hint"><b>${escapeHtml(q.setTitle)}</b><br>${escapeHtml(q.setIntro)}</p>`;
    host.appendChild(intro);
  }

  const block = document.createElement("div");
  block.className = "qblock";
  block.innerHTML = `<p class="qtitle">${escapeHtml(q.title)}</p>` + (q.hint ? `<p class="hint">${escapeHtml(q.hint)}</p>` : "");

  if (q.type === "mcq"){
    const saved = APP.answers[q.id];
    q.options.forEach((opt,i)=>{
      const lab=document.createElement("label");
      lab.className="opt";
      lab.innerHTML = `<input type="radio" name="${q.id}" value="${i}" ${saved===i?"checked":""}/><div>${escapeHtml(opt)}</div>`;
      const input=lab.querySelector("input");
      lab.addEventListener("click",(e)=>{ if (e.target.tagName.toLowerCase()==="input") return; input.checked=true; APP.answers[q.id]=i; updateProgress(); });
      input.addEventListener("change",()=>{ APP.answers[q.id]=i; updateProgress(); });
      block.appendChild(lab);
    });
  }

  if (q.type === "checkbox"){
    const saved = Array.isArray(APP.answers[q.id]) ? APP.answers[q.id] : [];
    q.options.forEach((opt,i)=>{
      const lab=document.createElement("label");
      lab.className="opt";
      lab.innerHTML = `<input type="checkbox" value="${i}" ${saved.includes(i)?"checked":""}/><div>${escapeHtml(opt)}</div>`;
      const input=lab.querySelector("input");
      input.addEventListener("change",()=>{
        const arr = Array.isArray(APP.answers[q.id]) ? APP.answers[q.id] : [];
        const pos = arr.indexOf(i);
        if (input.checked && pos === -1) arr.push(i);
        if (!input.checked && pos !== -1) arr.splice(pos,1);
        APP.answers[q.id]=arr.sort((a,b)=>a-b);
        updateProgress();
      });
      block.appendChild(lab);
    });
  }

  if (q.type === "likert"){
    const saved = APP.answers[q.id] || {};
    q.items.forEach((item,rowIdx)=>{
      const row=document.createElement("div");
      row.className="qblock";
      row.style.borderTop="1px solid var(--line)";
      row.innerHTML = `<p class="qtitle" style="margin:0 0 8px">${escapeHtml(item)}</p>`;
      q.scale.forEach((s,i)=>{
        const lab=document.createElement("label");
        lab.className="opt";
        lab.style.margin="6px 0";
        lab.innerHTML = `<input type="radio" name="${q.id}_${rowIdx}" value="${i}" ${(saved[rowIdx]===i)?"checked":""}/><div>${escapeHtml(s)}</div>`;
        const input=lab.querySelector("input");
        input.addEventListener("change",()=>{
          const obj = APP.answers[q.id] || {};
          obj[rowIdx]=i;
          APP.answers[q.id]=obj;
          updateProgress();
        });
        row.appendChild(lab);
      });
      block.appendChild(row);
    });
  }

  host.appendChild(block);

  el("btnBack").disabled = APP.idx===0;
  el("btnNext").textContent = (APP.idx===APP.flatQuestions.length-1) ? "Finish" : "Next";
}

/* =========================
   SCORING + INTERPRETATION
========================= */
function computeScores(){
  const started = !!APP.meta.startedAt;
  let aScore=0,aMax=9,bScore=0,bMax=7,cScore=0,cMax=10;

  const aQ = APP.flatQuestions.find(q=>q.id==="A1");
  if (aQ) aScore = aQ.score(APP.answers["A1"]);

  for (let i=1;i<=7;i++){
    const id="B"+i;
    const q=APP.flatQuestions.find(x=>x.id===id);
    const ans=APP.answers[id];
    if (q && ans!==undefined && ans===q.correctIndex) bScore++;
  }
  for (let i=1;i<=10;i++){
    const id="C"+i;
    const q=APP.flatQuestions.find(x=>x.id===id);
    const ans=APP.answers[id];
    if (q && ans!==undefined && ans===q.correctIndex) cScore++;
  }

  const confSummary = summarizeConfidence(APP.answers["B8"]);
  const total=aScore+bScore+cScore;
  const maxTotal=aMax+bMax+cMax;
  return { started,aScore,aMax,bScore,bMax,cScore,cMax,total,maxTotal,confSummary };
}
function summarizeConfidence(confObj){
  if (!confObj || typeof confObj!=="object") return "—";
  const values = Object.values(confObj).filter(v=>typeof v==="number");
  if (!values.length) return "—";
  const avg = values.reduce((s,v)=>s+v,0)/values.length;
  if (avg>=2.5) return "High";
  if (avg>=1.5) return "Medium";
  return "Low";
}
function interpretLevel(scores){
  let level="Beginner", badgeClass="bBad";
  if (scores.total>=19){ level="Advanced"; badgeClass="bGood"; }
  else if (scores.total>=10){ level="Intermediate"; badgeClass="bWarn"; }
  if (scores.bScore<=2){ level="Beginner"; badgeClass="bBad"; }
  if (scores.cScore>=8 && scores.bScore>=5){ level="Advanced"; badgeClass="bGood"; }

  const bullets=[];
  if (scores.aScore<=2) bullets.push("Experience signals are low. Recommend a fundamentals-first pathway to avoid frustration.");
  if (scores.aScore>=7) bullets.push("Strong experience signals. Validate with Set B and Set C results for accurate placement.");
  if (scores.bScore<=2) bullets.push("Tool recognition baseline is weak. Participant may need guided practice on Tables, filtering, and core functions.");
  if (scores.bScore>=5) bullets.push("Solid working proficiency on core Excel tools (filtering, lookups, tables, pivots, basic cleaning).");
  if (scores.cScore<=3) bullets.push("Excel thinking maturity is limited; focus on step-by-step foundations and repeatable workflows.");
  if (scores.cScore>=7) bullets.push("Strong workflow thinking. Participant is likely ready for advanced reporting patterns and robust model design.");
  if (scores.confSummary==="Low") bullets.push("Low confidence indicators. Trainer should slow down early and use reassurance + quick wins.");
  if (scores.confSummary==="High") bullets.push("High confidence indicators. Trainer can introduce optional challenge tasks to keep engagement high.");

  const recommendation = buildRecommendation(level, scores);
  return { level, badgeClass, bullets, recommendation };
}
function buildRecommendation(level, scores){
  const map={
    Beginner:{
      enroll:"Excel Beginner / Fundamentals",
      focus:[
        "Data entry discipline and formatting (numbers, dates, text)",
        "Relative vs absolute references",
        "Core formulas: SUM/AVERAGE/COUNT, basic IF",
        "Sorting & filtering properly",
        "Excel Tables basics"
      ],
      caution:"Avoid heavy PivotTables and complex lookups on Day 1; introduce gradually after confidence builds."
    },
    Intermediate:{
      enroll:"Excel Intermediate",
      focus:[
        "Tables + structured references for scalable reporting",
        "Lookup functions (XLOOKUP/VLOOKUP) applied to real lists",
        "PivotTables (build, refresh, group, basic layout design)",
        "Charts for management (choose correct chart types)",
        "Data cleaning essentials (Remove Duplicates, Text to Columns, TRIM basics)"
      ],
      caution:"If Set C is low, teach with more structure: input → clean → analyse → present."
    },
    Advanced:{
      enroll:"Excel Advanced / Reporting & Analysis",
      focus:[
        "Advanced PivotTable design patterns (slicers, multiple views, maintainability)",
        "Robust lookup strategy (XLOOKUP, structured refs, error handling)",
        "Data cleaning workflows and repeatability",
        "Performance thinking (reduce volatile formulas, model structure)",
        "Presentation-ready outputs (dashboards, KPI storytelling)"
      ],
      caution:"Include challenge track for fast learners; ensure fundamentals are consistent across the group."
    }
  };
  const cfg=map[level];
  let edge="";
  if (level==="Intermediate" && scores.bScore<=3) edge="Note: Tool recognition is borderline. Consider enrolling in Intermediate but start with a short fundamentals recap (first 60–90 minutes).";
  if (level==="Advanced" && scores.cScore<7) edge="Note: Advanced score driven by tools more than workflow thinking. In Advanced class, include a structured refresher on model design and maintainability.";
  return { enroll:cfg.enroll, focus:cfg.focus, caution:cfg.caution, edge };
}

/* =========================
   RADAR
========================= */
const RADAR_AXES=[
  {key:"formatting",label:"Formatting"},
  {key:"basicFormulas",label:"Basic Formulas"},
  {key:"lookups",label:"Lookups"},
  {key:"sortFilter",label:"Sort/Filter"},
  {key:"tables",label:"Tables"},
  {key:"pivots",label:"PivotTables"},
  {key:"charts",label:"Charts"},
  {key:"cleaning",label:"Data Cleaning"},
  {key:"thinking",label:"Workflow Thinking"}
];

function computeRadarScores(){
  const a = Array.isArray(APP.answers["A1"]) ? APP.answers["A1"] : [];
  const tick = (idx)=>a.includes(idx)?1:0;
  const correct=(id)=>{
    const q=APP.flatQuestions.find(x=>x.id===id);
    const ans=APP.answers[id];
    return (q && ans!==undefined && ans===q.correctIndex)?1:0;
  };

  const A_FORMAT=tick(0);
  const A_BASIC=tick(1)+tick(2);
  const A_LOOKUP=tick(3);
  const A_SORT=tick(4);
  const A_TABLE=tick(5);
  const A_PIVOT=tick(6);
  const A_CHART=tick(7);
  const A_CLEAN=tick(8);

  const B_SORT=correct("B1");
  const B_LOOKUP=correct("B2");
  const B_TABLE=correct("B3");
  const B_PIVOT=correct("B4");
  const B_CLEAN=correct("B5")+correct("B7");
  const B_CHART=correct("B6");

  const thinkingBoost=(["C1","C2","C3","C4","C5","C6","C7","C8","C9","C10"].reduce((s,id)=>s+correct(id),0)/10);

  function scale(v01){ return Math.max(0, Math.min(5, Math.round(v01*50)/10)); }

  const scores01={
    formatting:(0.70*A_FORMAT+0.30*thinkingBoost),
    basicFormulas:(0.60*Math.min(1,A_BASIC/2)+0.40*thinkingBoost),
    lookups:(0.40*A_LOOKUP+0.45*B_LOOKUP+0.15*thinkingBoost),
    sortFilter:(0.40*A_SORT+0.45*B_SORT+0.15*thinkingBoost),
    tables:(0.40*A_TABLE+0.45*B_TABLE+0.15*thinkingBoost),
    pivots:(0.40*A_PIVOT+0.45*B_PIVOT+0.15*thinkingBoost),
    charts:(0.40*A_CHART+0.45*B_CHART+0.15*thinkingBoost),
    cleaning:(0.35*A_CLEAN+0.50*Math.min(1,B_CLEAN/2)+0.15*thinkingBoost),
    thinking:thinkingBoost
  };

  const out={};
  for (const ax of RADAR_AXES) out[ax.key]=scale(scores01[ax.key]);
  return out;
}

function drawRadar(canvas, axes, valuesByKey){
  const ctx=canvas.getContext("2d");
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const cx=w/2, cy=h/2, pad=54;
  const R=Math.min(w,h)/2 - pad;

  const grid="rgba(255,255,255,0.10)";
  const muted="rgba(184,195,230,0.85)";
  const polyFill="rgba(122,162,255,0.18)";
  const polyStroke="rgba(122,162,255,0.95)";
  const point="rgba(61,220,151,0.92)";

  const levels=5;
  ctx.lineWidth=1;
  for (let lv=1; lv<=levels; lv++){
    const r=(R*lv)/levels;
    ctx.beginPath();
    for (let i=0;i<axes.length;i++){
      const a=(Math.PI*2*i)/axes.length - Math.PI/2;
      const x=cx + r*Math.cos(a), y=cy + r*Math.sin(a);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle=grid; ctx.stroke();
  }

  for (let i=0;i<axes.length;i++){
    const a=(Math.PI*2*i)/axes.length - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx + R*Math.cos(a), cy + R*Math.sin(a));
    ctx.strokeStyle=grid; ctx.stroke();
  }

  ctx.font="12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillStyle=muted;
  axes.forEach((ax,i)=>{
    const a=(Math.PI*2*i)/axes.length - Math.PI/2;
    const x=cx + (R+18)*Math.cos(a), y=cy + (R+18)*Math.sin(a);
    const align=(Math.cos(a)>0.3)?"left":(Math.cos(a)<-0.3)?"right":"center";
    ctx.textAlign=align; ctx.textBaseline="middle";
    ctx.fillText(ax.label,x,y);
  });

  const pts=[];
  ctx.beginPath();
  axes.forEach((ax,i)=>{
    const v=valuesByKey[ax.key] ?? 0;
    const r=(R*v)/5;
    const a=(Math.PI*2*i)/axes.length - Math.PI/2;
    const x=cx + r*Math.cos(a), y=cy + r*Math.sin(a);
    pts.push({x,y});
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.fillStyle=polyFill; ctx.strokeStyle=polyStroke; ctx.lineWidth=2;
  ctx.fill(); ctx.stroke();

  pts.forEach(p=>{
    ctx.beginPath(); ctx.arc(p.x,p.y,3.4,0,Math.PI*2);
    ctx.fillStyle=point; ctx.fill();
  });
}

function renderRadarFocus(values05){
  const arr = RADAR_AXES.map(ax=>({...ax, v: values05[ax.key] ?? 0})).sort((a,b)=>a.v-b.v);
  const weakest = arr.slice(0,3);
  const strongest = arr.slice(-2).reverse();

  const host = el("radarFocusList");
  host.innerHTML="";

  const mk=(title, text, cls, tag)=>{
    const d=document.createElement("div");
    d.className="metric";
    d.innerHTML = `<div><b>${escapeHtml(title)}</b><div class="hint" style="margin:4px 0 0">${escapeHtml(text)}</div></div><span class="badge ${cls}">${escapeHtml(tag)}</span>`;
    return d;
  };

  if (strongest[0]) host.appendChild(mk(
    `Top Strength: ${strongest[0].label} (${strongest[0].v}/5)`,
    "Use this to build confidence while introducing harder topics.",
    strongest[0].v>=4?"bGood":strongest[0].v>=3?"bWarn":"bBad",
    strongest[0].v>=4?"Strength":strongest[0].v>=3?"Developing":"Needs Focus"
  ));
  if (strongest[1]) host.appendChild(mk(
    `Second Strength: ${strongest[1].label} (${strongest[1].v}/5)`,
    "Optional challenge tasks can be assigned in this area.",
    strongest[1].v>=4?"bGood":strongest[1].v>=3?"bWarn":"bBad",
    strongest[1].v>=4?"Strength":strongest[1].v>=3?"Developing":"Needs Focus"
  ));

  weakest.forEach((w, idx)=>host.appendChild(mk(
    `Focus Area ${idx+1}: ${w.label} (${w.v}/5)`,
    "Prioritize this early; it unlocks faster progress in later modules.",
    w.v>=4?"bGood":w.v>=3?"bWarn":"bBad",
    w.v>=4?"Strength":w.v>=3?"Developing":"Needs Focus"
  )));
}

/* =========================
   FLOW
========================= */
function startAssessment(){
  const name = el("participantName").value.trim();
  const dept = el("participantDept").value.trim();
  const role = el("participantRole").value.trim();

  if (!name || !dept || !role){
    toast("Please fill in Name, Department, and Job Role to begin.");
    return;
  }

  APP.meta.name = name;
  APP.meta.dept = dept;
  APP.meta.role = role;
  APP.meta.startedAt = new Date().toISOString();
  APP.idx = 0;

  showScreen("q");
  renderCurrentQuestion();
  startTimer();
}

function startTimer(){
  stopTimer();
  APP.remaining = APP.durationSeconds;
  updateProgress();
  APP.timer = setInterval(()=>{
    APP.remaining--;
    updateProgress();
    if (APP.remaining<=0){
      stopTimer();
      toast("Time is up. Finalizing results.");
      finishAssessment();
    }
  },1000);
}
function stopTimer(){ if (APP.timer) clearInterval(APP.timer); APP.timer=null; }

function next(){
  if (APP.idx >= APP.flatQuestions.length - 1){ finishAssessment(); return; }
  APP.idx++;
  renderCurrentQuestion();
}
function back(){
  if (APP.idx<=0) return;
  APP.idx--;
  renderCurrentQuestion();
}

function finishAssessment(){
  stopTimer();
  APP.meta.endedAt = new Date().toISOString();

  const scores = computeScores();
  const interpreted = interpretLevel(scores);

  el("resultSummaryText").textContent =
    `Participant: ${APP.meta.name}. Department: ${APP.meta.dept}. Role: ${APP.meta.role}. ` +
    `This result is diagnostic and recommends the most suitable Excel training level.`;

  el("overallBadge").textContent = interpreted.level;
  el("overallBadge").className = "badge " + interpreted.badgeClass;

  el("scoreBadge").textContent = `${scores.total}/${scores.maxTotal}`;
  el("scoreBadge").className = "badge " + (interpreted.level==="Advanced" ? "bGood" : interpreted.level==="Intermediate" ? "bWarn" : "bBad");

  el("aBadge").textContent = `${scores.aScore}/${scores.aMax}`;
  el("aBadge").className = "badge " + (scores.aScore>=6 ? "bGood" : scores.aScore>=3 ? "bWarn" : "bBad");

  el("bBadge").textContent = `${scores.bScore}/${scores.bMax}`;
  el("bBadge").className = "badge " + (scores.bScore>=5 ? "bGood" : scores.bScore>=3 ? "bWarn" : "bBad");

  el("cBadge").textContent = `${scores.cScore}/${scores.cMax}`;
  el("cBadge").className = "badge " + (scores.cScore>=8 ? "bGood" : scores.cScore>=5 ? "bWarn" : "bBad");

  el("confBadge").textContent = scores.confSummary;
  el("confBadge").className = "badge " + (scores.confSummary==="High" ? "bGood" : scores.confSummary==="Medium" ? "bWarn" : "bBad");

  const ul = el("interpretList");
  ul.innerHTML="";
  interpreted.bullets.forEach(b=>{ const li=document.createElement("li"); li.textContent=b; ul.appendChild(li); });

  const rec=interpreted.recommendation;
  let recText=`Recommended enrollment: ${rec.enroll}. `;
  recText+=`Focus areas: ${rec.focus.join("; ")}. `;
  recText+=`Trainer note: ${rec.caution}`;
  if (rec.edge) recText+=" " + rec.edge;
  el("recommendationText").textContent = recText;

  const radarValues=computeRadarScores();
  drawRadar(el("radar"), RADAR_AXES, radarValues);
  renderRadarFocus(radarValues);
  el("radarLevelPill").textContent = `Overall: ${interpreted.level}`;

  el("stepTitle").textContent="Completed";
  setStage("Completed");
  showScreen("result");
  updateProgress();
}

function resetAll(){
  stopTimer();
  APP.idx=0;
  APP.answers={};
  APP.meta={ name:"", dept:"", role:"", startedAt:null, endedAt:null };

  el("participantName").value="";
  el("participantDept").value="";
  el("participantRole").value="";

  el("stepTitle").textContent="Start";
  setStage("—");
  el("progressFill").style.width="0%";
  el("timerPill").textContent="10:00";
  el("timeBadge").textContent="10:00";
  el("stepPill").textContent=`0/${APP.flatQuestions.length}`;
  el("completionBadge").textContent=`0/${APP.flatQuestions.length}`;
  el("liveEstimate").textContent="—";
  showScreen("start");
  toast("Reset complete.");
  
  // Reset Upload Button
  const btn = el("btnUpload");
  if(btn){
    btn.textContent = "Submit to HR";
    btn.disabled = false;
    btn.style.background = "#4285F4";
    btn.style.color = "white";
  }
}

/* =========================
   EXPORTS
========================= */
function buildExportPayload(){
  const scores = computeScores();
  const interpreted = interpretLevel(scores);
  const radar = computeRadarScores();
  return {
    meta: APP.meta,
    answers: APP.answers,
    scores,
    radar,
    interpretation: {
      overallLevel: interpreted.level,
      bullets: interpreted.bullets,
      recommendation: interpreted.recommendation
    }
  };
}

function downloadJSON(){
  const payload = buildExportPayload();
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = (APP.meta.name || "participant").replace(/[^\w\-]+/g, "_");
  a.href = url;
  a.download = `excel_preassessment_${safeName}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function downloadWordDoc(){
  const p = buildExportPayload();
  const s = p.scores;
  const lvl = p.interpretation.overallLevel;
  const rec = p.interpretation.recommendation;

  const startedAt = p.meta.startedAt ? new Date(p.meta.startedAt).toLocaleString() : "—";
  const endedAt = p.meta.endedAt ? new Date(p.meta.endedAt).toLocaleString() : "—";

  // Radar image best-effort
  let radarImgTag="";
  try{
    const canvas = el("radar");
    const dataUrl = canvas.toDataURL("image/png");
    radarImgTag = `<p><b>Strength Radar</b></p><p><img src="${dataUrl}" style="max-width:650px;width:100%;height:auto;border:1px solid #ddd;border-radius:10px" /></p>`;
  }catch(e){
    radarImgTag = `<p><b>Strength Radar</b></p><p><i>(Radar image not available. See radar table below.)</i></p>`;
  }

  const radarRows = RADAR_AXES.map(ax => `
    <tr>
      <td style="border:1px solid #ddd;padding:8px">${escapeHtml(ax.label)}</td>
      <td style="border:1px solid #ddd;padding:8px;text-align:center">${p.radar[ax.key] ?? 0}</td>
    </tr>
  `).join("");

  const bullets = (p.interpretation.bullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("");

  const docHtml = `
  <!doctype html><html><head><meta charset="utf-8"><title>Excel Pre-Assessment Result</title>
  <style>
    body{font-family: Calibri, Arial, sans-serif; font-size: 11pt; color:#111; margin: 28px;}
    h1{font-size: 18pt; margin:0 0 10px}
    h2{font-size: 13pt; margin:18px 0 8px}
    .meta{margin: 6px 0 14px; padding: 12px; background:#f6f7fb; border:1px solid #e5e7ef; border-radius:10px;}
    .grid{border-collapse: collapse; width:100%; margin: 8px 0 14px}
    .grid th{background:#f2f3f7; border:1px solid #ddd; padding:8px; text-align:left}
    .grid td{border:1px solid #ddd; padding:8px}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #ddd; font-weight:700}
    .good{background:#e9fbf1; border-color:#b8efd2}
    .warn{background:#fff7e6; border-color:#ffe2a8}
    .bad{background:#ffe9ee; border-color:#ffc0cd}
    .small{font-size:10pt; color:#555}
  </style></head><body>
    <h1>Microsoft Excel Pre-Assessment Result</h1>
    <div class="meta">
      <div><b>Participant:</b> ${escapeHtml(p.meta.name)} &nbsp;&nbsp; <b>Department:</b> ${escapeHtml(p.meta.dept)} &nbsp;&nbsp; <b>Role:</b> ${escapeHtml(p.meta.role)}</div>
      <div><b>Started:</b> ${escapeHtml(startedAt)} &nbsp;&nbsp; <b>Completed:</b> ${escapeHtml(endedAt)}</div>
      <div style="margin-top:10px"><b>Overall Level:</b>
        <span class="pill ${lvl==="Advanced"?"good":(lvl==="Intermediate"?"warn":"bad")}">${escapeHtml(lvl)}</span>
      </div>
    </div>

    <h2>Score Breakdown</h2>
    <table class="grid">
      <tr><th>Total Score</th><td>${s.total}/${s.maxTotal}</td></tr>
      <tr><th>Set A (Experience)</th><td>${s.aScore}/${s.aMax}</td></tr>
      <tr><th>Set B (Micro Scenarios)</th><td>${s.bScore}/${s.bMax}</td></tr>
      <tr><th>Set C (Advanced Thinking)</th><td>${s.cScore}/${s.cMax}</td></tr>
      <tr><th>Confidence Signals</th><td>${escapeHtml(s.confSummary)}</td></tr>
    </table>

    ${radarImgTag}

    <h2>Strength Radar Table (0–5)</h2>
    <table class="grid">
      <tr><th>Skill Area</th><th style="text-align:center">Score</th></tr>
      ${radarRows}
    </table>
    <p class="small">Rule of thumb: any score ≤ 2 indicates a priority support area for the participant.</p>

    <h2>Interpretation</h2>
    <ul>${bullets || "<li>No interpretation notes captured.</li>"}</ul>

    <h2>Recommendation</h2>
    <p><b>Recommended enrollment:</b> ${escapeHtml(rec.enroll)}</p>
    <p><b>Focus areas:</b> ${escapeHtml(rec.focus.join("; "))}</p>
    <p><b>Trainer note:</b> ${escapeHtml(rec.caution)}${rec.edge ? " " + escapeHtml(rec.edge) : ""}</p>

    <hr style="border:none;border-top:1px solid #ddd;margin:18px 0">
    <p class="small">This assessment is diagnostic and intended for training placement and class customization.</p>
  </body></html>`;

  const blob = new Blob([docHtml], { type: "application/msword" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = (p.meta.name || "participant").replace(/[^\w\-]+/g, "_");
  a.href = url;
  a.download = `excel_preassessment_${safeName}.doc`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
  toast("Word document downloaded.");
}

/* =========================
   DEMO
========================= */
function loadDemo(){
  el("participantName").value = "Demo Participant";
  el("participantDept").value = "Finance";
  el("participantRole").value = "Accounts Executive";

  APP.answers["A1"] = [0,1,2,3,4,5,6,7];
  APP.answers["B1"]=2; APP.answers["B2"]=2; APP.answers["B3"]=1;
  APP.answers["B4"]=2; APP.answers["B5"]=2; APP.answers["B6"]=1; APP.answers["B7"]=1;
  APP.answers["B8"] = {0:2, 1:2, 2:3};
  for (let i=1;i<=10;i++){
    const q = QUESTION_SETS[2].questions.find(x=>x.id==="C"+i);
    APP.answers["C"+i] = q.correctIndex;
  }
  APP.answers["C3"]=0; APP.answers["C10"]=1;
  toast("Demo data loaded.");
}

/* =========================
   GOOGLE SHEETS INTEGRATION
========================= */
// TODO: Replace this URL with your actual "Web App URL" from Google Sheets > Extensions > Apps Script > Deploy
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOoHZ0pVxmhGqW1LifR2caadkL5eDD5EDn3YSqt9OkIBU-fTRm-fAXbIX_DxT0OGm_/exec"; 

async function uploadResult() {
  const btn = el("btnUpload");
  const originalText = btn.textContent;
  
  // Visual feedback
  btn.textContent = "Sending...";
  btn.disabled = true;

  const payload = buildExportPayload();

  try {
    // We use no-cors to allow the browser to send data to Google from a local file.
    // In this mode, we cannot read the response, but if no error is thrown, it worked.
    await fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors", 
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      body: JSON.stringify(payload)
    });

    toast("Result submitted to HR successfully!");
    btn.textContent = "Submitted";
    btn.style.background = "#3ddc97"; // Success Green
    btn.style.color = "#0b1220";
    
  } catch (error) {
    console.error(error);
    toast("Connection failed. Please use Download instead.");
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

/* =========================
   INIT
========================= */
buildFlatQuestions();
el("stepPill").textContent = `0/${APP.flatQuestions.length}`;
el("completionBadge").textContent = `0/${APP.flatQuestions.length}`;
showScreen("start");
setStage("—");
updateProgress();

/* Bind */
el("btnStart").addEventListener("click", ()=>startAssessment());
el("btnLoadSample").addEventListener("click", ()=>{
  loadDemo();
  startAssessment();
});
el("btnNext").addEventListener("click", ()=>next());
el("btnBack").addEventListener("click", ()=>back());
el("btnReset").addEventListener("click", ()=>resetAll());
el("btnDownload").addEventListener("click", ()=>downloadJSON());
el("btnDownloadWord").addEventListener("click", ()=>downloadWordDoc());

// Bind new Upload Button
if(el("btnUpload")){
  el("btnUpload").addEventListener("click", ()=>uploadResult());
}

window.addEventListener("beforeunload",(e)=>{
  if (APP.meta.startedAt && !APP.meta.endedAt){
    e.preventDefault();
    e.returnValue="";
  }
});
</script>
</body>
</html>